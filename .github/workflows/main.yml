name: BeamDashBoardPro Python Application Build

on:
  push:
    tags:
      - 'v*' # Push events to matching v*, i.e. v1.0, v20.15.10
  #   branches: [ main ]
  #   paths-ignore:
  #     - 'README.md'
  # pull_request:
  #   branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Make Expiration
      run: |
        python make_expiration.py

    - name: Build with PyInstaller
      run: |
        pyinstaller streamlit_runner.spec
        
    - name: Stage build
      run: |
        cp -r dist "${{ runner.temp }}/dist"
        
    - name: Stage scripts
      run: |
        cp DashboardPro.cs "${{ runner.temp }}/dist/DashboardPro.cs"
        cp dashboard.py "${{ runner.temp }}/dist/dashboard.py"

    - name: Zip
      run: |
        Compress-Archive `
          -Path "${{ runner.temp }}/dist/*" `
          -DestinationPath "${{ github.workspace }}/${{ github.event.repository.name }}${{ github.ref_name }}-portablePyESAPI.zip"
    
    - name: Create Release
      uses: softprops/action-gh-release@v0.1.13
      with:
        name: ${{env.PROJECT_NAME}}${{ steps.update_assembly_info.outputs.RELEASE_FILE_NAME }}-portablePyESAPI
        tag_name: ${{ github.ref_name }}
        token: ${{ secrets.GITHUB_TOKEN }}
        draft: false
        prerelease: false
        body: |
          This is an official `${{  github.ref_name }}` release of the **`${{ github.event.repository.name }}`** project.
          Supported Eclipse version: v16+.
          This software is valid until 365 post release.
        files: ${{ github.workspace }}/${{ github.event.repository.name }}${{ github.ref_name }}-portablePyESAPI.zip
#    - name: Upload artifact
#      uses: actions/upload-artifact@v2
#      with:
#        name: DashboardPro${{  github.ref_name }}
#        path: ${{ runner.temp }}/dist/*
